const translations = {
    ar: {
        title: "Ù†Ø¸Ø§Ù… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ÙŠ",
        subtitle: "Ù†Ø¸Ø§Ù… Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ÙŠ Ù„Ù„Ø·Ù„Ø§Ø¨",
        themeToggle: "ðŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ",
        themeToggleLight: "â˜€ï¸ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ",
        calculate: "Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù„",
        reset: "Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†",
        exportPDF: "ðŸ“„ ØªØµØ¯ÙŠØ± Ø¥Ù„Ù‰ PDF",
        resultsTitle: "Ø§Ù„Ù†ØªØ§Ø¦Ø¬",
        subjectResults: "Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ÙˆØ§Ø¯",
        footer: "Â© 2026 Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©",
        coreSubjects: "ðŸ“š Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (40% Ù…Ø±Ø§Ù‚Ø¨Ø© + 60% Ø§Ù…ØªØ­Ø§Ù†)",
        examOnlySubjects: "ðŸ“ Ù…ÙˆØ§Ø¯ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† ÙÙ‚Ø· (100% Ø§Ù…ØªØ­Ø§Ù†)",
        practicalSubjects: "ðŸ”¬ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (100% Ø£Ø¹Ù…Ø§Ù„ Ù…ÙˆØ¬Ù‡Ø©)",
        subjectName: "Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©",
        coefficient: "Ø§Ù„Ù…Ø¹Ø§Ù…Ù„",
        continuous: "Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø±Ø©",
        exam: "Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†",
        practical: "Ø§Ù„Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ÙˆØ¬Ù‡Ø©",
        passed: "Ù†Ø§Ø¬Ø­",
        failed: "Ø±Ø§Ø³Ø¨",
        successMsg: "Ù…Ø¨Ø±ÙˆÙƒ! Ù„Ù‚Ø¯ Ù†Ø¬Ø­Øª Ø¨ØªÙÙˆÙ‚. Ø§Ø³ØªÙ…Ø± ÙÙŠ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¬Ø§Ø¯ ÙˆØ§Ù„ØªÙ…ÙŠØ² Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ.",
        failMsg: "Ù„Ø§ ØªÙŠØ£Ø³! Ø§Ù„ÙØ´Ù„ ÙØ±ØµØ© Ù„Ù„ØªØ¹Ù„Ù… ÙˆØ§Ù„Ù†Ù…Ùˆ. Ø±Ø§Ø¬Ø¹ Ø¯Ø±ÙˆØ³Ùƒ ÙˆØ§Ø³ØªØ¹Ø¯ Ø¬ÙŠØ¯Ø§Ù‹ Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©.",
        average: "Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø¹Ø§Ù…",
        status: "Ø§Ù„Ø­Ø§Ù„Ø©",
        finalGrade: "Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ",
        type: "Ø§Ù„Ù†ÙˆØ¹",
        core: "Ø£Ø³Ø§Ø³ÙŠ",
        examOnly: "Ø§Ù…ØªØ­Ø§Ù†",
        practicalOnly: "Ø¹Ù…Ù„ÙŠ",
        pdfTitle: "ØªÙ‚Ø±ÙŠØ± Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ",
        pdfGenerated: "ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆÙ„ÙŠØ¯",
        semesterAverage: "Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø§Ù„ÙØµÙ„ÙŠ",
        grades: "Ø§Ù„Ø¯Ø±Ø¬Ø§Øª"
    },
    fr: {
        title: "SystÃ¨me de Calcul de Moyenne Semestrielle",
        subtitle: "SystÃ¨me Ã©lectronique pour le calcul de la moyenne semestrielle des Ã©tudiants",
        themeToggle: "ðŸŒ™ Mode Nuit",
        themeToggleLight: "â˜€ï¸ Mode Jour",
        calculate: "Calculer la Moyenne",
        reset: "RÃ©initialiser",
        exportPDF: "ðŸ“„ Exporter en PDF",
        resultsTitle: "RÃ©sultats",
        subjectResults: "RÃ©sultats des MatiÃ¨res",
        footer: "Â© 2026 SystÃ¨me de Gestion des Ã‰tudiants - Tous droits rÃ©servÃ©s",
        coreSubjects: "ðŸ“š MatiÃ¨res Fondamentales (40% CC + 60% Examen)",
        examOnlySubjects: "ðŸ“ MatiÃ¨res Ã  Examen Uniquement (100% Examen)",
        practicalSubjects: "ðŸ”¬ MatiÃ¨res Pratiques (100% TP)",
        subjectName: "Nom de la MatiÃ¨re",
        coefficient: "Coefficient",
        continuous: "ContrÃ´le Continu",
        exam: "Examen",
        practical: "Travaux Pratiques",
        passed: "Admis",
        failed: "AjournÃ©",
        successMsg: "FÃ©licitations! Vous avez rÃ©ussi avec succÃ¨s. Continuez votre excellent travail acadÃ©mique.",
        failMsg: "Ne vous dÃ©couragez pas! L'Ã©chec est une opportunitÃ© d'apprentissage. RÃ©visez et prÃ©parez-vous mieux pour la prochaine fois.",
        average: "Moyenne GÃ©nÃ©rale",
        status: "Statut",
        finalGrade: "Note Finale",
        type: "Type",
        core: "Fondamental",
        examOnly: "Examen",
        practicalOnly: "Pratique",
        pdfTitle: "Rapport des RÃ©sultats du Semestre",
        pdfGenerated: "Date de GÃ©nÃ©ration",
        semesterAverage: "Moyenne Semestrielle",
        grades: "Notes"
    },
    en: {
        title: "Semester Average Calculation System",
        subtitle: "Electronic system for calculating student semester averages",
        themeToggle: "ðŸŒ™ Night Mode",
        themeToggleLight: "â˜€ï¸ Day Mode",
        calculate: "Calculate Average",
        reset: "Reset",
        exportPDF: "ðŸ“„ Export to PDF",
        resultsTitle: "Results",
        subjectResults: "Subject Results",
        footer: "Â© 2026 Student Management System - All Rights Reserved",
        coreSubjects: "ðŸ“š Core Subjects (40% CA + 60% Exam)",
        examOnlySubjects: "ðŸ“ Exam-Only Subjects (100% Exam)",
        practicalSubjects: "ðŸ”¬ Practical Subjects (100% Practical Work)",
        subjectName: "Subject Name",
        coefficient: "Coefficient",
        continuous: "Continuous Assessment",
        exam: "Exam",
        practical: "Practical Work",
        passed: "Passed",
        failed: "Failed",
        successMsg: "Congratulations! You have passed successfully. Keep up the excellent academic work.",
        failMsg: "Don't give up! Failure is an opportunity to learn and grow. Review your lessons and prepare better next time.",
        average: "Overall Average",
        status: "Status",
        finalGrade: "Final Grade",
        type: "Type",
        core: "Core",
        examOnly: "Exam",
        practicalOnly: "Practical",
        pdfTitle: "Semester Results Report",
        pdfGenerated: "Generation Date",
        semesterAverage: "Semester Average",
        grades: "Grades"
    }
};

const subjectConfig = {
    core: [
        { name: { ar: "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª 03", fr: "MathÃ©matiques 03", en: "Mathematics 03" }, coefficient: 3 },
        { name: { ar: "Ø§Ù„Ù…ÙˆØ¬Ø§Øª Ùˆ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²Ø§Øª", fr: "ondes et vibrations", en: "ondes & vibrations" }, coefficient: 2 },
        { name: { ar: "Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙƒ Ø§Ù„Ø§Ø³Ø§Ø³ÙŠØ© 1", fr: "electronique fondamental 1", en: "electronic fondamental 1" }, coefficient: 2 },
        { name: { ar: "Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆØªÙ‚Ù†ÙŠ Ø§Ù„Ø§Ø³Ø§Ø³ÙŠØ© 1", fr: "electrothechnique fondamental 1", en: "electrothechnic fondamental 1" }, coefficient: 2 },
        { name: { ar: "Ø§Ù„Ø§Ø­ØµØ§Ø¡ Ùˆ Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª", fr: "proba et stat", en: "proba & stat" }, coefficient: 2 }
    ],
    examOnly: [
        { name: { ar: "Ø§Ø­Ø¯Ø« Ø§Ù„ØªÙ‚Ù†ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©", fr: "Etat de l'art du gÃ©nie Ã©lectrique", en: "State of the art in electrical engineering" }, coefficient: 1 },
        { name: { ar: "Ø§Ù„Ø·Ø§Ù‚Ø© Ùˆ Ø§Ù„Ø¨ÙŠØ¦Ø©", fr: "Energies et environnement", en: "Energy and environment" }, coefficient: 1 },
        { name: { ar: "Ø§Ù„Ù„ØºØ© Ø§Ù„Ø§Ù†Ø¬Ù„ÙŠØ²ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ© ", fr: "Anglais technique", en: " Technical english" }, coefficient: 1 }
    ],
    practical: [
        { name: { ar: "Ø£Ø´ØºØ§Ù„ ØªØ·Ø¨ÙŠÙ‚ÙŠØ© Ø§Ù„Ù…ÙˆØ¬Ø§Øª Ùˆ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²Ø§Øª", fr: "TP ondes et vibrations", en: "ondes & vibrations Lab" }, coefficient: 1 },
        { name: { ar: "Ø£Ø´ØºØ§Ù„ ØªØ·Ø¨ÙŠÙ‚ÙŠØ© Ø§Ù„ÙƒØªØ±ÙˆÙ†ÙŠÙƒ 1 Ùˆ Ø§Ù„Ø§Ù„ÙƒØªØ±ÙˆØªÙ‚Ù†ÙŠ 1", fr: "TP electronique 1 et electrothechnique 1 ", en: "electronic 1 et electrothechnic 1 Lab" }, coefficient: 1 },
        { name: { ar: " Ø¥Ø¹Ù„Ø§Ù… Ø¢Ù„ÙŠ03 ", fr: "Informatique", en: "Computer Science" }, coefficient: 1 }
    ]
};

let currentLang = 'fr';
let currentTheme = 'light';
let subjectsData = {};

function init() {
    loadFromStorage();
    initializeSubjectsData();
    renderSubjects();
    updateAllTexts();

    if (currentTheme === 'dark') {
        document.body.setAttribute('data-theme', 'dark');
    }
}

function initializeSubjectsData() {
    let index = 0;

    ['core', 'examOnly', 'practical'].forEach(category => {
        subjectConfig[category].forEach((subject) => {
            if (!subjectsData[index]) {
                subjectsData[index] = {
                    name: subject.name,
                    coefficient: subject.coefficient,
                    type: category,
                    continuous: '',
                    exam: '',
                    practical: ''
                };
            }
            index++;
        });
    });
}

function renderSubjects() {
    const container = document.getElementById('subjectsContainer');
    container.innerHTML = '';

    const categories = [
        { key: 'core', icon: 'ðŸ“š' },
        { key: 'examOnly', icon: 'ðŸ“' },
        { key: 'practical', icon: 'ðŸ”¬' }
    ];

    let globalIndex = 0;

    categories.forEach(category => {
        const categoryDiv = document.createElement('div');
        categoryDiv.className = 'subject-category';

        const categoryHeader = document.createElement('div');
        categoryHeader.className = 'category-header';
        categoryHeader.innerHTML = `
            <span class="category-icon">${category.icon}</span>
            <h2 class="category-title" id="cat_${category.key}">${translations[currentLang][category.key + 'Subjects']}</h2>
        `;
        categoryDiv.appendChild(categoryHeader);

        subjectConfig[category.key].forEach((subject) => {
            const data = subjectsData[globalIndex];

            const subjectCard = document.createElement('div');
            subjectCard.className = 'subject-card';

            let gradesHTML = '';
            if (category.key === 'core') {
                gradesHTML = `
                    <div class="input-group">
                        <label id="lbl_cont_${globalIndex}">${translations[currentLang].continuous}</label>
                        <input type="number" min="0" max="20" step="0.25" 
                               placeholder="0.00" 
                               value="${data.continuous}"
                               onchange="updateSubject(${globalIndex}, 'continuous', this.value)">
                    </div>
                    <div class="input-group">
                        <label id="lbl_exam_${globalIndex}">${translations[currentLang].exam}</label>
                        <input type="number" min="0" max="20" step="0.25" 
                               placeholder="0.00"
                               value="${data.exam}"
                               onchange="updateSubject(${globalIndex}, 'exam', this.value)">
                    </div>
                `;
            } else if (category.key === 'examOnly') {
                gradesHTML = `
                    <div class="input-group">
                        <label id="lbl_exam_${globalIndex}">${translations[currentLang].exam}</label>
                        <input type="number" min="0" max="20" step="0.25" 
                               placeholder="0.00"
                               value="${data.exam}"
                               onchange="updateSubject(${globalIndex}, 'exam', this.value)">
                    </div>
                `;
            } else {
                gradesHTML = `
                    <div class="input-group">
                        <label id="lbl_prac_${globalIndex}">${translations[currentLang].practical}</label>
                        <input type="number" min="0" max="20" step="0.25" 
                               placeholder="0.00"
                               value="${data.practical}"
                               onchange="updateSubject(${globalIndex}, 'practical', this.value)">
                    </div>
                `;
            }

            subjectCard.innerHTML = `
                <div class="subject-header">
                    <div class="subject-info">
                        <span class="subject-info-label" id="lbl_name_${globalIndex}">${translations[currentLang].subjectName}</span>
                        <span class="subject-info-value">${subject.name[currentLang]}</span>
                    </div>
                    <div class="subject-info">
                        <span class="subject-info-label" id="lbl_coef_${globalIndex}">${translations[currentLang].coefficient}</span>
                        <span class="subject-info-value">${data.coefficient}</span>
                    </div>
                </div>
                <div class="grades-grid">
                    ${gradesHTML}
                </div>
            `;

            categoryDiv.appendChild(subjectCard);
            globalIndex++;
        });

        container.appendChild(categoryDiv);
    });
}

function updateSubject(index, field, value) {
    subjectsData[index][field] = value;
    saveToStorage();
}

function calculateAverage() {
    let totalWeighted = 0;
    let totalCoefficients = 0;
    const results = [];

    Object.keys(subjectsData).forEach((key) => {
        const subject = subjectsData[key];
        if (!subject || !subject.coefficient) return;

        let finalGrade = 0;
        const coef = parseFloat(subject.coefficient) || 0;

        if (subject.type === 'core') {
            const cont = parseFloat(subject.continuous) || 0;
            const exam = parseFloat(subject.exam) || 0;
            finalGrade = (cont * 0.4) + (exam * 0.6);
        } else if (subject.type === 'examOnly') {
            finalGrade = parseFloat(subject.exam) || 0;
        } else if (subject.type === 'practical') {
            finalGrade = parseFloat(subject.practical) || 0;
        }

        totalWeighted += finalGrade * coef;
        totalCoefficients += coef;

        results.push({
            name: subject.name,
            coefficient: coef,
            type: subject.type,
            continuous: subject.continuous,
            exam: subject.exam,
            practical: subject.practical,
            finalGrade: finalGrade.toFixed(2)
        });
    });

    const average = totalCoefficients > 0 ? (totalWeighted / totalCoefficients) : 0;
    displayResults(average, results);
}

function displayResults(average, results) {
    const resultCard = document.getElementById('resultCard');
    const averageDisplay = document.getElementById('averageDisplay');
    const statusBadge = document.getElementById('statusBadge');
    const motivationMessage = document.getElementById('motivationMessage');
    const resultsTable = document.getElementById('resultsTable');

    const passed = average >= 10;

    averageDisplay.textContent = average.toFixed(2);
    averageDisplay.className = `average-display ${passed ? 'success' : 'danger'}`;

    statusBadge.textContent = translations[currentLang][passed ? 'passed' : 'failed'];
    statusBadge.className = `status-badge ${passed ? 'success' : 'danger'}`;

    motivationMessage.textContent = translations[currentLang][passed ? 'successMsg' : 'failMsg'];

    let tableHTML = `
        <thead>
            <tr>
                <th>${translations[currentLang].subjectName}</th>
                <th>${translations[currentLang].coefficient}</th>
                <th>${translations[currentLang].type}</th>
                <th>${translations[currentLang].grades}</th>
                <th>${translations[currentLang].finalGrade}</th>
            </tr>
        </thead>
        <tbody>
    `;

    results.forEach(result => {
        const typeLabel = translations[currentLang][result.type];
        let gradesText = '';

        if (result.type === 'core') {
            gradesText = `${translations[currentLang].continuous}: ${result.continuous || '-'} / ${translations[currentLang].exam}: ${result.exam || '-'}`;
        } else if (result.type === 'examOnly') {
            gradesText = `${translations[currentLang].exam}: ${result.exam || '-'}`;
        } else {
            gradesText = `${translations[currentLang].practical}: ${result.practical || '-'}`;
        }

        tableHTML += `
            <tr>
                <td>${result.name[currentLang]}</td>
                <td>${result.coefficient}</td>
                <td>${typeLabel}</td>
                <td>${gradesText}</td>
                <td><strong>${result.finalGrade}</strong></td>
            </tr>
        `;
    });

    tableHTML += '</tbody>';
    resultsTable.innerHTML = tableHTML;

    resultCard.classList.add('show');
    resultCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    localStorage.setItem('lastAverage', average.toFixed(2));
    localStorage.setItem('lastResults', JSON.stringify(results));
}

function exportToPDF() {
    const pdfLang = currentLang === 'ar' ? 'fr' : currentLang;
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    const average = parseFloat(localStorage.getItem('lastAverage')) || 0;
    const results = JSON.parse(localStorage.getItem('lastResults') || '[]');
    const passed = average >= 10;
    const studentName = document.getElementById('studentName').value.trim() || 'Student';

    const pageWidth = doc.internal.pageSize.width;
    const pageHeight = doc.internal.pageSize.height;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.setTextColor(26, 84, 144);
    doc.text(translations[pdfLang].pdfTitle, pageWidth / 2, 20, { align: "center" });

    doc.setFontSize(12);
    doc.setTextColor(40);
    const nameLabel = pdfLang === 'fr' ? 'Etudiant' : 'Student';
    doc.text(`${nameLabel} : ${studentName}`, pageWidth / 2, 30, { align: "center" });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(10);
    const date = new Date().toLocaleDateString(
        pdfLang === 'fr' ? 'fr-FR' : 'en-US',
        { year: 'numeric', month: 'long', day: 'numeric' }
    );
    doc.text(`Date : ${date}`, pageWidth / 2, 38, { align: "center" });

    doc.setFont("helvetica", "bold");
    doc.setFontSize(16);
    doc.setTextColor(passed ? 40 : 220, passed ? 167 : 53, passed ? 69 : 69);
    const avgLabel = pdfLang === 'fr' ? 'Moyenne Semestrielle' : 'Semester Average';
    doc.text(`${avgLabel} : ${average.toFixed(2)}`, pageWidth / 2, 50, { align: "center" });

    doc.setFontSize(13);
    doc.setTextColor(0);
    const statusLabel = pdfLang === 'fr' ? 'Statut' : 'Status';
    const statusValue = passed
        ? (pdfLang === 'fr' ? 'Admis' : 'Passed')
        : (pdfLang === 'fr' ? 'Ajourne' : 'Failed');
    doc.text(`${statusLabel} : ${statusValue}`, pageWidth / 2, 60, { align: "center" });

    const tableHeaders = pdfLang === 'fr'
        ? ['Matiere', 'Coef', 'Type', 'Notes', 'Final']
        : ['Subject', 'Coef', 'Type', 'Grades', 'Final'];

    const tableData = results.map(r => {
        let grades = '';
        if (r.type === 'core') {
            grades = `CC: ${r.continuous || '-'} / Ex: ${r.exam || '-'}`;
        } else if (r.type === 'examOnly') {
            grades = `Ex: ${r.exam || '-'}`;
        } else {
            grades = `TP: ${r.practical || '-'}`;
        }

        const typeText = r.type === 'core'
            ? (pdfLang === 'fr' ? 'Fondamental' : 'Core')
            : r.type === 'examOnly'
                ? (pdfLang === 'fr' ? 'Examen' : 'Exam')
                : (pdfLang === 'fr' ? 'Pratique' : 'Practical');

        const subjectName = r.name[pdfLang] || r.name['fr'] || r.name['en'];

        return [
            subjectName,
            r.coefficient.toString(),
            typeText,
            grades,
            r.finalGrade
        ];
    });

    doc.autoTable({
        head: [tableHeaders],
        body: tableData,
        startY: 68,
        theme: 'striped',
        headStyles: {
            fillColor: [26, 84, 144],
            textColor: 255,
            halign: 'center',
            fontSize: 10,
            fontStyle: 'bold'
        },
        bodyStyles: { 
            halign: 'center', 
            fontSize: 9 
        },
        styles: {
            font: 'helvetica',
            cellPadding: 4,
            lineColor: [200, 200, 200],
            lineWidth: 0.1
        },
        columnStyles: {
            0: { cellWidth: 60, halign: 'left' },
            1: { cellWidth: 15 },
            2: { cellWidth: 25 },
            3: { cellWidth: 55 },
            4: { cellWidth: 20 }
        },
        alternateRowStyles: {
            fillColor: [245, 247, 250]
        }
    });

    const finalY = doc.lastAutoTable.finalY + 12;
    doc.setFont("helvetica", "italic");
    doc.setFontSize(10);
    doc.setTextColor(60);

    const message = passed
        ? translations[pdfLang].successMsg
        : translations[pdfLang].failMsg;

    const splitMsg = doc.splitTextToSize(message, pageWidth - 30);
    doc.text(splitMsg, pageWidth / 2, finalY, { align: 'center' });

    doc.setFont("helvetica", "normal");
    doc.setFontSize(8);
    doc.setTextColor(100);
    doc.text(
        'Developed by Fertas Mohammed Redha',
        pageWidth / 2,
        pageHeight - 15,
        { align: 'center' }
    );

    const fileName = `${studentName.replace(/\s+/g, '-')}-semester-results.pdf`;
    doc.save(fileName);
}

function resetAll() {
    const messages = {
        ar: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŸ',
        fr: 'ÃŠtes-vous sÃ»r de vouloir rÃ©initialiser toutes les donnÃ©es?',
        en: 'Are you sure you want to reset all data?'
    };

    if (confirm(messages[currentLang])) {
        subjectsData = {};
        localStorage.removeItem('subjectsData');
        localStorage.removeItem('lastAverage');
        localStorage.removeItem('lastResults');
        document.getElementById('resultCard').classList.remove('show');
        initializeSubjectsData();
        renderSubjects();
    }
}

function setLanguage(lang) {
    currentLang = lang;

    document.documentElement.lang = lang;
    document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');

    localStorage.setItem('language', lang);
    renderSubjects();
    updateAllTexts();
}

function updateAllTexts() {
    document.getElementById('headerTitle').textContent = translations[currentLang].title;
    document.getElementById('headerSubtitle').textContent = translations[currentLang].subtitle;
    document.getElementById('themeToggle').textContent = translations[currentLang][currentTheme === 'dark' ? 'themeToggleLight' : 'themeToggle'];
    document.getElementById('btnCalculate').textContent = translations[currentLang].calculate;
    document.getElementById('btnReset').textContent = translations[currentLang].reset;
    document.getElementById('btnExport').textContent = translations[currentLang].exportPDF;
    document.getElementById('resultsTitle').textContent = translations[currentLang].resultsTitle;
    document.getElementById('subjectResultsTitle').textContent = translations[currentLang].subjectResults;
    document.getElementById('footerText').textContent = translations[currentLang].footer;
}

function toggleTheme() {
    currentTheme = currentTheme === 'light' ? 'dark' : 'light';
    document.body.setAttribute('data-theme', currentTheme);

    document.getElementById('themeToggle').textContent = translations[currentLang][currentTheme === 'dark' ? 'themeToggleLight' : 'themeToggle'];

    localStorage.setItem('theme', currentTheme);
}

function saveToStorage() {
    localStorage.setItem('subjectsData', JSON.stringify(subjectsData));
}

function loadFromStorage() {
    const savedLang = localStorage.getItem('language');
    if (savedLang) {
        currentLang = savedLang;
        document.documentElement.lang = savedLang;
        document.documentElement.dir = savedLang === 'ar' ? 'rtl' : 'ltr';
    }

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        currentTheme = savedTheme;
    }

    const savedData = localStorage.getItem('subjectsData');
    if (savedData) {
        try {
            subjectsData = JSON.parse(savedData);
        } catch (e) {
            subjectsData = {};
        }
    }

    const savedName = localStorage.getItem('studentName');
    if (savedName) {
        const nameInput = document.getElementById('studentName');
        if (nameInput) nameInput.value = savedName;
    }

    setTimeout(() => {
        const nameInput = document.getElementById('studentName');
        if (nameInput) {
            nameInput.addEventListener('input', function () {
                localStorage.setItem('studentName', this.value);
            });
        }
    }, 100);
}

window.addEventListener('DOMContentLoaded', init);
